
ALTER TABLE HRIS_ROLE_PERMISSIONS DROP CONSTRAINT ROLE_PERM_PK;

ALTER TABLE HRIS_ROLE_PERMISSIONS ADD CONSTRAINT ROLE_MENU_UNQ UNIQUE(MENU_ID,ROLE_ID);


ALTER TABLE HRIS_JOB_HISTORY ADD FROM_COMPANY_ID NUMBER(7,0) ;

ALTER TABLE HRIS_JOB_HISTORY ADD TO_COMPANY_ID NUMBER(7,0) ;

ALTER TABLE HRIS_JOB_HISTORY ADD CONSTRAINT JOB_HIST_COMP_FK_1 FOREIGN KEY(FROM_COMPANY_ID) REFERENCES HRIS_COMPANY(COMPANY_ID);

ALTER TABLE HRIS_JOB_HISTORY ADD CONSTRAINT JOB_HIST_COMP_FK_2 FOREIGN KEY(TO_COMPANY_ID) REFERENCES HRIS_COMPANY(COMPANY_ID);


--TRIGGER START PRABIN
create or replace TRIGGER UPDATE_EMPLOYEE_SERVICE AFTER INSERT OR UPDATE ON HRIS_JOB_HISTORY
FOR EACH ROW
DECLARE
BEGIN
UPDATE HRIS_EMPLOYEES 
SET BRANCH_ID=:new.TO_BRANCH_ID,
DEPARTMENT_ID=:new.TO_DEPARTMENT_ID,
DESIGNATION_ID=:new.TO_DESIGNATION_ID,
POSITION_ID=:new.TO_POSITION_ID,
SERVICE_TYPE_ID=:new.TO_SERVICE_TYPE_ID,
SERVICE_EVENT_TYPE_ID=:new.SERVICE_EVENT_TYPE_ID,
COMPANY_ID=:new.TO_COMPANY_ID
WHERE EMPLOYEE_ID=:new.EMPLOYEE_ID;

IF (:new.SERVICE_EVENT_TYPE_ID=2) THEN
UPDATE HRIS_EMPLOYEES 
SET APP_BRANCH_ID=:new.TO_BRANCH_ID,
APP_DEPARTMENT_ID=:new.TO_DEPARTMENT_ID,
APP_DESIGNATION_ID=:new.TO_DESIGNATION_ID,
APP_POSITION_ID=:new.TO_POSITION_ID,
APP_SERVICE_TYPE_ID=:new.TO_SERVICE_TYPE_ID,
APP_SERVICE_EVENT_TYPE_ID=:new.SERVICE_EVENT_TYPE_ID,
RETIRED_FLAG='N'
WHERE EMPLOYEE_ID=:new.EMPLOYEE_ID;
END IF;

IF (:new.SERVICE_EVENT_TYPE_ID=1 OR :new.SERVICE_EVENT_TYPE_ID=3 OR :new.SERVICE_EVENT_TYPE_ID=4) THEN
UPDATE HRIS_EMPLOYEES 
SET RETIRED_FLAG='N'
WHERE EMPLOYEE_ID=:new.EMPLOYEE_ID;
END IF;

IF (:new.SERVICE_EVENT_TYPE_ID=5 OR :new.SERVICE_EVENT_TYPE_ID=8 OR :new.SERVICE_EVENT_TYPE_ID=14) THEN
UPDATE HRIS_EMPLOYEES 
SET RETIRED_FLAG='Y'
WHERE EMPLOYEE_ID=:new.EMPLOYEE_ID;
END IF;
END;

-- TRIGGER  end

-- INSERT -- COMPANY CHANGE EVENT PRABIN
Insert into HRIS_SERVICE_EVENT_TYPES (SERVICE_EVENT_TYPE_ID,SERVICE_EVENT_TYPE_CODE,SERVICE_EVENT_TYPE_NAME,REMARKS,STATUS,CREATED_DT,MODIFIED_DT) values (17,'SET17','Company Transfer','testing','E',to_date('10-NOV-16','DD-MON-RR'),to_date('04-DEC-16','DD-MON-RR'));