CREATE OR REPLACE PROCEDURE JGI_ATTENDANCE(
    P_ATTENDANCE_DT DATE,
    P_EMPLOYEE_ID   NUMBER)
AS
  V_START_TIME HRIS_SHIFTS.START_TIME%TYPE            :=NULL;
  V_END_TIME HRIS_SHIFTS.END_TIME%TYPE                :=NULL;
  V_GRACE_START_TIME HRIS_SHIFTS.GRACE_START_TIME%TYPE:=NULL;
  V_GRACE_END_TIME HRIS_SHIFTS.GRACE_END_TIME%TYPE    :=NULL;
  V_LATE_IN HRIS_SHIFTS.LATE_IN%TYPE;
  V_EARLY_OUT HRIS_SHIFTS.EARLY_OUT%TYPE;
  V_IN_TIME HRIS_ATTENDANCE_DETAIL.IN_TIME%TYPE;
  V_OUT_TIME HRIS_ATTENDANCE_DETAIL.OUT_TIME%TYPE;
  V_LATE_STATUS HRIS_ATTENDANCE_DETAIL.LATE_STATUS%TYPE:='N';
BEGIN
  BEGIN
    SELECT S.START_TIME,
      S.END_TIME,
      S.GRACE_START_TIME,
      S.GRACE_END_TIME,
      S.LATE_IN,
      S.EARLY_OUT
    INTO V_START_TIME,
      V_END_TIME,
      V_GRACE_START_TIME,
      V_GRACE_END_TIME,
      V_LATE_IN,
      V_EARLY_OUT
    FROM HRIS_SHIFTS S
    JOIN HRIS_EMPLOYEE_SHIFT_ASSIGN SA
    ON (SA.SHIFT_ID     = S.SHIFT_ID)
    WHERE SA.EMPLOYEE_ID=P_EMPLOYEE_ID
    AND (P_ATTENDANCE_DT BETWEEN S.START_DATE AND S.END_DATE)
    AND S.CURRENT_SHIFT = 'Y'
    AND S.STATUS        = 'E'
    AND SA.STATUS       ='E'
    AND ROWNUM          <2;
  EXCEPTION
  WHEN NO_DATA_FOUND THEN
    BEGIN
      SELECT S.START_TIME,
        S.END_TIME,
        S.GRACE_START_TIME,
        S.GRACE_END_TIME,
        S.LATE_IN,
        S.EARLY_OUT
      INTO V_START_TIME,
        V_END_TIME,
        V_GRACE_START_TIME,
        V_GRACE_END_TIME,
        V_LATE_IN,
        V_EARLY_OUT
      FROM HRIS_SHIFTS S
      WHERE S.CURRENT_SHIFT='Y'
      AND S.DEFAULT_SHIFT  ='Y'
      AND S.STATUS         ='E'
      AND P_ATTENDANCE_DT BETWEEN S.START_DATE AND S.END_DATE;
    EXCEPTION
    WHEN NO_DATA_FOUND THEN
      RAISE_APPLICATION_ERROR(-20344, 'No default and normal shift defined for this time period');
    END;
  END;
  BEGIN
    NULL;
    SELECT IN_TIME,
      OUT_TIME
    INTO V_IN_TIME,
      V_OUT_TIME
    FROM HRIS_ATTENDANCE_DETAIL
    WHERE EMPLOYEE_ID = P_EMPLOYEE_ID
    AND ATTENDANCE_DT =P_ATTENDANCE_DT;
  EXCEPTION
  WHEN NO_DATA_FOUND THEN
    RAISE_APPLICATION_ERROR(-20344,'NO DATA FOUND FOR EMPLOYEE => '|| P_EMPLOYEE_ID || 'ON DATE => '||P_ATTENDANCE_DT);
  END;
  IF (V_START_TIME+(.000694+V_LATE_IN)<V_IN_TIME)THEN
    V_LATE_STATUS                    :='L';
  END IF;
  IF (V_END_TIME-(.000684+V_EARLY_OUT)>V_OUT_TIME) THEN
    V_LATE_STATUS                    :='E';
  END IF;
  IF((V_START_TIME+(.000694+V_LATE_IN)<V_IN_TIME) AND (V_END_TIME-(.000684+V_EARLY_OUT)>V_OUT_TIME)) THEN
    V_LATE_STATUS                    :='B';
  END IF;
  UPDATE HRIS_ATTENDANCE_DETAIL
  SET LATE_STATUS   =V_LATE_STATUS
  WHERE EMPLOYEE_ID = P_EMPLOYEE_ID
  AND ATTENDANCE_DT =P_ATTENDANCE_DT;
END;
