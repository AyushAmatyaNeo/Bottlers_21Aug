create or replace PROCEDURE HRIS_REATTENDANCE_TWO_DAY(
    P_ATTENDANCE_DT    DATE,
    P_EMPLOYEE_ID      NUMBER,
    P_SHIFT_ID         NUMBER,
    P_MONTH_START_DATE DATE,
    P_MONTH_END_DATE   DATE)
AS
  V_LATE_START_TIME TIMESTAMP;
  V_EARLY_END_TIME  TIMESTAMP;
  V_HALF_INTERVAL   DATE;
  v_NEXT_HALF_INTERVAL DATE;
  V_IN_TIME HRIS_ATTENDANCE_DETAIL.IN_TIME%TYPE;
  V_OUT_TIME HRIS_ATTENDANCE_DETAIL.OUT_TIME%TYPE;
  V_DIFF_IN_MIN NUMBER;
  V_OVERALL_STATUS HRIS_ATTENDANCE_DETAIL.OVERALL_STATUS%TYPE;
  V_LATE_STATUS HRIS_ATTENDANCE_DETAIL.LATE_STATUS%TYPE:='N';
  V_LATE_COUNT NUMBER;
BEGIN
  SELECT S.START_TIME+((1/1440)*NVL(S.LATE_IN,0)),
    S.END_TIME       -((1/1440)*NVL(S.EARLY_OUT,0))
  INTO V_LATE_START_TIME,
    V_EARLY_END_TIME
  FROM HRIS_SHIFTS S
  WHERE S.SHIFT_ID=P_SHIFT_ID ;
  --
  V_LATE_START_TIME := TO_DATE(TO_CHAR(P_ATTENDANCE_DT,'DD-MON-YYYY')||' '||TO_CHAR(V_LATE_START_TIME,'HH:MI AM'),'DD-MON-YYYY HH:MI AM');
  V_EARLY_END_TIME  := TO_DATE(TO_CHAR(P_ATTENDANCE_DT,'DD-MON-YYYY')||' '|| TO_CHAR(V_EARLY_END_TIME,'HH:MI AM'),'DD-MON-YYYY HH:MI AM');
  --
  SELECT V_EARLY_END_TIME + (V_LATE_START_TIME -V_EARLY_END_TIME)/2
  INTO V_HALF_INTERVAL
  FROM DUAL;
  V_NEXT_HALF_INTERVAL:=V_HALF_INTERVAL+1;
  --
  SELECT MIN(ATTENDANCE_TIME) AS IN_TIME,
    MAX(ATTENDANCE_TIME) OUT_TIME
  INTO V_IN_TIME,
    V_OUT_TIME
  FROM HRIS_ATTENDANCE
  WHERE (ATTENDANCE_TIME BETWEEN V_HALF_INTERVAL AND V_NEXT_HALF_INTERVAL)
  AND EMPLOYEE_ID = P_EMPLOYEE_ID ;
  --
  IF V_IN_TIME IS NULL THEN
    RETURN;
  END IF ;
  --
  IF V_IN_TIME  = V_OUT_TIME THEN
    V_OUT_TIME := NULL;
  END IF;
  --
  IF V_OUT_TIME IS NOT NULL THEN
    SELECT SUM(ABS(EXTRACT( HOUR FROM DIFF ))*60 + ABS(EXTRACT( MINUTE FROM DIFF )))
    INTO V_DIFF_IN_MIN
    FROM
      (SELECT V_OUT_TIME -V_IN_TIME AS DIFF FROM DUAL
      ) ;
  END IF;
  IF(V_OVERALL_STATUS     ='DO') THEN
    V_OVERALL_STATUS     :='WD';
  ELSIF (V_OVERALL_STATUS ='HD') THEN
    V_OVERALL_STATUS     :='WH';
  ELSIF (V_OVERALL_STATUS ='LV') THEN
    NULL;
  ELSIF (V_OVERALL_STATUS ='TV') THEN
    NULL;
  ELSIF (V_OVERALL_STATUS ='TN') THEN
    NULL;
  ELSE
    V_OVERALL_STATUS :='PR';
  END IF;
  --
  IF (V_LATE_START_TIME-TRUNC(V_LATE_START_TIME))<(V_IN_TIME-TRUNC(V_IN_TIME)) THEN
    V_LATE_STATUS                               :='L';
  END IF;
  --
  IF (V_EARLY_END_TIME-TRUNC(V_EARLY_END_TIME))>(V_OUT_TIME-TRUNC(V_OUT_TIME)) THEN
    IF (V_LATE_STATUS                          = 'L') THEN
      V_LATE_STATUS                           :='B';
    ELSE
      V_LATE_STATUS :='E';
    END IF;
  END IF;
  --
  IF V_IN_TIME      IS NOT NULL AND V_OUT_TIME IS NULL THEN
    IF V_LATE_STATUS ='L' THEN
      V_LATE_STATUS := 'Y';
    ELSE
      V_LATE_STATUS := 'X';
    END IF;
  END IF;
  --
  SELECT COUNT(*)
  INTO V_LATE_COUNT
  FROM HRIS_ATTENDANCE_DETAIL
  WHERE EMPLOYEE_ID = P_EMPLOYEE_ID
  AND (ATTENDANCE_DT BETWEEN P_MONTH_START_DATE AND P_ATTENDANCE_DT )
  AND OVERALL_STATUS           IN ('PR','LA')
  AND LATE_STATUS              IN ('E','L','Y') ;
  IF V_LATE_STATUS             IN ('E','L','Y') THEN
    V_LATE_COUNT       := V_LATE_COUNT+1;
    IF V_LATE_COUNT    != 0 AND MOD(V_LATE_COUNT,4)=0 THEN
      V_OVERALL_STATUS := 'LA';
    END IF;
  END IF;
  --
  IF V_LATE_STATUS   ='B' AND V_OVERALL_STATUS='PR' THEN
    V_OVERALL_STATUS:='BA';
  END IF;
  --
  UPDATE HRIS_ATTENDANCE_DETAIL
  SET IN_TIME         = V_IN_TIME,
    OUT_TIME          =V_OUT_TIME,
    OVERALL_STATUS    = V_OVERALL_STATUS,
    LATE_STATUS       = V_LATE_STATUS,
    TOTAL_HOUR        = V_DIFF_IN_MIN
  WHERE ATTENDANCE_DT = TRUNC(P_ATTENDANCE_DT)
  AND EMPLOYEE_ID     = P_EMPLOYEE_ID;
END;