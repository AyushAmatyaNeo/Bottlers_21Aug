create or replace PROCEDURE HRIS_BACKDATE_ATTENDANCE(
    P_ATTENDANCE_DT DATE,
    P_EMPLOYEE_ID HRIS_EMPLOYEES.EMPLOYEE_ID%TYPE,
    P_IN_TIME  TIMESTAMP,
    P_OUT_TIME TIMESTAMP)
AS
  V_IN_TIME HRIS_ATTENDANCE_DETAIL.IN_TIME%TYPE;
  V_OUT_TIME HRIS_ATTENDANCE_DETAIL.OUT_TIME%TYPE;
  V_DIFF_IN_MIN HRIS_ATTENDANCE_DETAIL.TOTAL_HOUR%TYPE;
BEGIN
  SELECT IN_TIME,
    OUT_TIME
  INTO V_IN_TIME,
    V_OUT_TIME
  FROM HRIS_ATTENDANCE_DETAIL
  WHERE EMPLOYEE_ID                  = P_EMPLOYEE_ID
  AND ATTENDANCE_DT                  =P_ATTENDANCE_DT;
  IF(V_IN_TIME                      IS NULL) THEN
    V_IN_TIME                       :=P_IN_TIME;
  ELSIF ((P_IN_TIME-TRUNC(P_IN_TIME))<(V_IN_TIME-TRUNC(V_IN_TIME))) THEN
    V_IN_TIME                       := P_IN_TIME;
  END IF;
  IF(V_OUT_TIME                       IS NULL) THEN
    V_OUT_TIME                        :=P_OUT_TIME;
  ELSIF ((P_OUT_TIME-TRUNC(P_OUT_TIME))>(V_OUT_TIME-TRUNC(V_OUT_TIME))) THEN
    V_OUT_TIME                        := P_OUT_TIME;
  END IF;
  IF V_OUT_TIME IS NOT NULL THEN
    SELECT SUM(ABS(EXTRACT( HOUR FROM DIFF ))*60 + ABS(EXTRACT( MINUTE FROM DIFF )))
    INTO V_DIFF_IN_MIN
    FROM
      (SELECT V_OUT_TIME -V_IN_TIME AS DIFF FROM DUAL
      ) ;
  END IF;
  UPDATE HRIS_ATTENDANCE_DETAIL
  SET IN_TIME      = V_IN_TIME ,
    OUT_TIME       =V_OUT_TIME,
    TOTAL_HOUR     = V_DIFF_IN_MIN
  WHERE EMPLOYEE_ID= P_EMPLOYEE_ID
  AND ATTENDANCE_DT= TRUNC(P_ATTENDANCE_DT);
  HRIS_POST_ATTENDANCE(P_ATTENDANCE_DT,P_EMPLOYEE_ID);
END;