create or replace PROCEDURE HRIS_REATTENDANCE(
    P_ATTENDANCE_DT DATE)
AS
  V_EMPLOYEE_ID HRIS_EMPLOYEES.EMPLOYEE_ID%TYPE;
  V_IN_TIME HRIS_ATTENDANCE_DETAIL.IN_TIME%TYPE;
  V_OUT_TIME HRIS_ATTENDANCE_DETAIL.OUT_TIME%TYPE;
  V_DIFF_IN_MIN NUMBER;
  CURSOR CUR_EMPLOYEE
  IS
    SELECT EMPLOYEE_ID
    FROM HRIS_EMPLOYEES
    WHERE STATUS    ='E'
    AND RETIRED_FLAG='N'
    AND IS_ADMIN    ='N';
BEGIN
  DELETE
  FROM HRIS_ATTENDANCE_DETAIL
  WHERE ATTENDANCE_DT= TRUNC(P_ATTENDANCE_DT);
  HRIS_PRELOAD_ATTENDANCE(P_ATTENDANCE_DT);
  OPEN CUR_EMPLOYEE;
  LOOP
    FETCH CUR_EMPLOYEE INTO V_EMPLOYEE_ID;
    EXIT
  WHEN CUR_EMPLOYEE%NOTFOUND;
    V_DIFF_IN_MIN:=NULL;
    SELECT MIN(TO_DATE(TO_CHAR(ATTENDANCE_TIME,'HH:MI AM'),'HH:MI AM')) AS IN_TIME,
      MAX(TO_DATE(TO_CHAR(ATTENDANCE_TIME,'HH:MI AM'),'HH:MI AM')) OUT_TIME
    INTO V_IN_TIME,
      V_OUT_TIME
    FROM HRIS_ATTENDANCE
    WHERE ATTENDANCE_DT =TRUNC(P_ATTENDANCE_DT)
    AND EMPLOYEE_ID     = V_EMPLOYEE_ID ;
    IF V_IN_TIME       IS NULL THEN
      CONTINUE;
    END IF ;
    IF V_IN_TIME  = V_OUT_TIME THEN
      V_OUT_TIME := NULL;
    END IF;
    IF V_OUT_TIME IS NOT NULL THEN
      SELECT SUM(ABS(EXTRACT( HOUR FROM DIFF ))*60 + ABS(EXTRACT( MINUTE FROM DIFF )))
      INTO V_DIFF_IN_MIN
      FROM
        (SELECT V_OUT_TIME -V_IN_TIME AS DIFF FROM DUAL
        ) ;
    END IF;
    UPDATE HRIS_ATTENDANCE_DETAIL
    SET IN_TIME      = V_IN_TIME ,
      OUT_TIME       =V_OUT_TIME,
      TOTAL_HOUR     = V_DIFF_IN_MIN
    WHERE EMPLOYEE_ID= V_EMPLOYEE_ID
    AND ATTENDANCE_DT= TRUNC(P_ATTENDANCE_DT);
    HRIS_POST_ATTENDANCE(P_ATTENDANCE_DT,V_EMPLOYEE_ID);
  END LOOP;
  CLOSE CUR_EMPLOYEE;
END;